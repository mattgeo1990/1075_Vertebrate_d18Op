---
title: "V1075 MonteCarlo"
author: "Matthew Allen"
date: "December 2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

### Here I demonstrate how one might run a Monte Carlo on $\delta$^18^O~bioapatite~-derived temperature proxies in order to estimate uncertainty. 

In this example we apply a dual-taxon temperature proxy sensu Fricke and Wing (2007). We'll use $\delta$^18^O data that I generated from the Albian (mid-Cretaceous) Oklahoma Museum of Natural History V1075 vertebrate microfossil assemblage from the Cloverly Formation of Montana. 

You can replace this input data with your data of interest. You'll need $\delta$^18^O data from an aquatic turtle and a freshwater fish, both from the same assemblage. You will also need the $\delta$^18^O of the NIST120c standards that were run with your samples. The turtle and fish .csv file will need to be formatted with mean $\delta$^18^O for each specimen, as well as the eco_type/taxon of each specimen.

```{r, results='hide', message=FALSE, warning=FALSE}
# Packages
packages <- c("dplyr", "purrr", "ggplot2", "Rcurl")

# install.packages(packages)

library(dplyr)
library(purrr)
library(ggplot2)
library(Rcurl)

# Data
    # Call d18Op data from GitHub, cleaned and averaged per specimen (V1075_BySpec.csv)
      samples_URL <- getURL("https://raw.githubusercontent.com/mattgeo1990/1075_Vertebrate_d18Op/main/Data/V1075_GarTurtle")
      V1075_GarTurtle <- read.csv(text = samples_URL)

    # Call NIST120c data from Github, compiled from 2 TC-EA runs
      standards_URL <-"https://raw.githubusercontent.com/mattgeo1990/1075_Vertebrate_d18Op/main/Data/V1075_NIST120c.csv"
        NIST120c <- read.csv(standards_URL)

```

## Resampling $\delta$^18^O~phosphate~

Here we are resampling with replacement, and taking the mean of each resample.

Let's plot a histogram to look at our resample means.

```{r, results='hide', message=FALSE, warning=FALSE}

# Set number of Monte Carlo repetitions 
  nMCrepetitions <- 1e5

# Subset V1075_GarTurtle into gar and turtle matrices
  gar <- subset(V1075_GarTurtle, eco_type = "Fish")
  turtle <- subset(V1075_GarTurtle, eco_type = "Aquatic Turtle")

# resample

  synth_gar <- data_frame(num = 1:nMCrepetitions) %>% 
  group_by(num) %>% 
  mutate(means = mean(sample(gar$d18O, replace = TRUE))) 

  synth_turtle <- data_frame(num = 1:nMCrepetitions) %>% 
    group_by(num) %>% 
    mutate(means = mean(sample(turtle$d18O, replace = TRUE))) 

  synth_NIST <- data_frame(num = 1:nMCrepetitions) %>% 
    group_by(num) %>% 
    mutate(means = mean(sample(NIST120c$d.18O.16O, replace = TRUE))) 

  # Plot histograms of each distribution
    # Combine data frames into one
      combined_data <- rbind(
        data.frame(group = "Gar", values = synth_gar$means),
        data.frame(group = "Turtle", values = synth_turtle$means),
        data.frame(group = "NIST", values = synth_NIST$means)
      )

    # Set order of facets
      combined_data$group <- factor(combined_data$group, levels = c("Gar", "Turtle", "NIST"))

    # Plotting with ggplot2 using facet_wrap
      ggplot(combined_data, aes(x = values, fill = group)) +
        geom_histogram(position = "identity", alpha = 0.7, bins = 30, color = "black") +
        labs(title = "Histogram of Means",
             x = "Means",
             y = "Frequency") +
        theme_minimal() +
        facet_wrap(~group, scales = "free")

```

## Calculate water oxygen isotope values from simulated turtle samples. 

Note that we are only using data from an aquatic turtle genus Glyptops spp. It is important to choose a turtle taxon that is thought to have been mostly or entirely aquatic in habit.

We'll do this using the relationship between environmental water and turtle bone defined by Barrick et al. (1999).

```{r}
# calculate water

  # create function
    turtlewater <- function(synthmeans_turtle){
      1.01 *(synthmeans_turtle) - 22.3 #Barrick et al. (1999)
    }

  # run turtlewater on synth_turtle
    synth_turtle <- synth_turtle %>%
      mutate(d18Owater = turtlewater(means))


```

## Calculate Temperatures

We'll use the relationship between $\delta$^18^O~phosphate~ and temperature defined originally by Longinelli & Nuti (1973) and refined by Puc\'eat et al. (2010)

```{r, results='hide', message=FALSE, warning=FALSE}
# calculate temps
    # define temp function
    TempFun <- function(d18Ofish, NISTmean, d18Owater) {
      temp <- 118.7 - 4.22*((d18Ofish  +(22.6 - NISTmean)) - d18Owater) 
    }

    # run TempFun over all the synthetic means
    synth_temps <- TempFun(d18Ofish = synth_gar$means, 
                           NISTmean = synth_NIST$means,
                           d18Owater = synth_turtle$d18Owater)
    
    # plot temps
    # hist(synth_temps, breaks = 100)

```

## Confidence Interval

```{r, message=FALSE, warning=FALSE}
# Calculate the confidence interval
    
    sample.mean <- mean(synth_temps)
    
    sample.n <- length(synth_temps)
    sample.sd <- sd(synth_temps)
    sample.se <- sample.sd/sqrt(sample.n)
    print(sample.se)
        
    alpha = 0.05
    degrees.freedom = sample.n - 1
    t.score = qt(p=alpha/2, df=degrees.freedom,lower.tail=F)
    print(t.score)
    
    margin.error <- t.score * sample.se
    
    lower.bound <- sample.mean - margin.error
    upper.bound <- sample.mean + margin.error
    print(c(lower.bound,upper.bound))
```
